{% extends "base_template.html" %}

{% block title %}Author: {{ author.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 col-md-10">
        <div class="card shadow-sm mb-3">
            <div class="card-body d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="h4 mb-1">{{ author.name }}</h1>
                    <p class="text-muted mb-2">
                        Followers: <span id="author-follower-count">{{ author_follower_count }}</span>
                    </p>
                    {% if author.affiliation %}
                        <p class="mb-1"><strong>Affiliation:</strong> {{ author.affiliation }}</p>
                    {% endif %}
                    {% if author.orcid %}
                        <p class="mb-1"><strong>ORCID:</strong> {{ author.orcid }}</p>
                    {% endif %}
                </div>
                <div class="text-end">
                    {% if current_user.is_authenticated %}
                        <button
                            type="button"
                            class="btn btn-sm btn-primary"
                            id="author-follow-toggle"
                            data-author-id="{{ author.id }}"
                            data-is-following="{{ 'true' if is_following_author else 'false' }}"
                        >
                            {% if is_following_author %}
                                Unfollow
                            {% else %}
                                Follow
                            {% endif %}
                        </button>
                        <div id="author-follow-message" class="small text-muted mt-2"></div>
                    {% else %}
                        <a href="{{ url_for('auth.login') }}" class="btn btn-outline-primary btn-sm">
                            Log in to follow this author
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-light">
        <h2 class="h5 mb-0">Datasets de este autor</h2>
    </div>
    <div class="card-body p-0">
        {% if datasets %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Título</th>
                            <th class="text-center">Tipo</th>
                            <th class="text-center">Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dataset in datasets %}
                            {% set md = dataset.ds_meta_data %}
                            {% set doi = md.dataset_doi if md else None %}
                            {% if doi %}
                                {% set detail_url = url_for('dataset.subdomain_index', doi=doi) %}
                            {% else %}
                                {% set detail_url = url_for('dataset.view_dataset', dataset_id=dataset.id) %}
                            {% endif %}
                            <tr>
                                <td>
                                    <a href="{{ detail_url }}">{{ md.title if md else ('Dataset ' ~ dataset.id) }}</a>
                                    <div class="text-muted small">{{ md.description[:120] ~ ('...' if md and md.description|length > 120 else '') }}</div>
                                </td>
                                <td class="text-center text-nowrap">{{ dataset.type|capitalize }}</td>
                                <td class="text-center text-nowrap">
                                    {{ dataset.created_at.strftime('%Y-%m-%d') if dataset.created_at else '—' }}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="p-3 text-muted">Este autor todavía no tiene datasets publicados.</div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        const btn = document.getElementById("author-follow-toggle");
        if (!btn) {
            return;
        }

        const messageEl = document.getElementById("author-follow-message");
        const followerCountEl = document.getElementById("author-follower-count");
        const followUrl = "{{ url_for('auth.follow_author', author_id=author.id) }}";
        const unfollowUrl = "{{ url_for('auth.unfollow_author', author_id=author.id) }}";

        async function toggleAuthorFollow() {
            const isFollowing = btn.getAttribute("data-is-following") === "true";
            const targetUrl = isFollowing ? unfollowUrl : followUrl;

            try {
                const response = await fetch(targetUrl, {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({}),
                    credentials: "include",
                });

                const data = await response.json();
                messageEl.textContent = data.message || "";

                if (response.ok) {
                    const count = parseInt(followerCountEl.textContent || "0", 10);
                    if (isFollowing) {
                        btn.textContent = "Follow";
                        btn.setAttribute("data-is-following", "false");
                        followerCountEl.textContent = Math.max(0, count - 1);
                    } else {
                        btn.textContent = "Unfollow";
                        btn.setAttribute("data-is-following", "true");
                        followerCountEl.textContent = count + 1;
                    }
                }
            } catch (error) {
                console.error("Error toggling author follow:", error);
                messageEl.textContent = "Something went wrong.";
            }
        }

        btn.addEventListener("click", toggleAuthorFollow);
    })();
</script>
{% endblock %}

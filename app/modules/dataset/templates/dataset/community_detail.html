{% extends "base_template.html" %}

{% block title %}Community: {{ community_id }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 col-md-10">
        <div class="card shadow-sm mb-3">
            <div class="card-body d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="h4 mb-1">Community: {{ community_id }}</h1>
                    <p class="text-muted mb-2">
                        Followers: <span id="community-follower-count">{{ community_follower_count }}</span>
                    </p>
                </div>
                <div class="text-end">
                    {% if current_user.is_authenticated %}
                        <button
                            type="button"
                            class="btn btn-sm btn-primary"
                            id="community-follow-toggle"
                            data-community-id="{{ community_id }}"
                            data-is-following="{{ 'true' if is_following_community else 'false' }}"
                        >
                            {% if is_following_community %}
                                Unfollow
                            {% else %}
                                Follow
                            {% endif %}
                        </button>
                        <div id="community-follow-message" class="small text-muted mt-2"></div>
                    {% else %}
                        <a href="{{ url_for('auth.login') }}" class="btn btn-outline-primary btn-sm">
                            Log in to follow this community
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        const btn = document.getElementById("community-follow-toggle");
        if (!btn) {
            return;
        }

        const messageEl = document.getElementById("community-follow-message");
        const followerCountEl = document.getElementById("community-follower-count");
        const followUrl = "{{ url_for('auth.follow_community', community_id=community_id) }}";
        const unfollowUrl = "{{ url_for('auth.unfollow_community', community_id=community_id) }}";

        async function toggleCommunityFollow() {
            const isFollowing = btn.getAttribute("data-is-following") === "true";
            const targetUrl = isFollowing ? unfollowUrl : followUrl;

            try {
                const response = await fetch(targetUrl, {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({}),
                    credentials: "include",
                });

                const data = await response.json();
                messageEl.textContent = data.message || "";

                if (response.ok) {
                    const count = parseInt(followerCountEl.textContent || "0", 10);
                    if (isFollowing) {
                        btn.textContent = "Follow";
                        btn.setAttribute("data-is-following", "false");
                        followerCountEl.textContent = Math.max(0, count - 1);
                    } else {
                        btn.textContent = "Unfollow";
                        btn.setAttribute("data-is-following", "true");
                        followerCountEl.textContent = count + 1;
                    }
                }
            } catch (error) {
                console.error("Error toggling community follow:", error);
                messageEl.textContent = "Something went wrong.";
            }
        }

        btn.addEventListener("click", toggleCommunityFollow);
    })();
</script>
{% endblock %}
